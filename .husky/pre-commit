#!/bin/sh
# .husky/pre-commit
# Enforces permissions.policy.json

echo "ğŸ”’ Checking permissions policy..."

# Read the policy file
POLICY_FILE=".ai/permissions.policy.json"

if [ ! -f "$POLICY_FILE" ]; then
  echo "âš ï¸  Warning: $POLICY_FILE not found. Skipping check."
  exit 0
fi

# Get the commit diff
CHANGED_FILES=$(git diff --cached --name-only)

# Check for blocked paths
BLOCKED_PATHS=$(node -p "JSON.parse(require('fs').readFileSync('$POLICY_FILE')).blocked_paths.join('|')")

echo "$CHANGED_FILES" | while read file; do
  if echo "$file" | grep -E "$BLOCKED_PATHS" > /dev/null; then
    echo "âŒ BLOCKED: Cannot modify $file (blocked by permissions.policy.json)"
    exit 1
  fi
done

echo "âœ… Permissions check passed."
exit 0
